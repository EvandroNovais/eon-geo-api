name: ğŸ” Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    name: ğŸ” Credential Leak Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Scan for Secrets with TruffleHog
      uses: trufflesecurity/trufflehog@main
      continue-on-error: true
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: ğŸ” Custom Credential Patterns
      run: |
        echo "ğŸ” Escaneando padrÃµes customizados..."
        
        # Patterns especÃ­ficos do projeto
        PATTERNS=(
          "redis://default:[^@]+@redis-[0-9]+"
          "AIza[0-9A-Za-z_-]{35}"
          "eon_[a-z0-9_]{8,}"
        )
        
        found=0
        for pattern in "${PATTERNS[@]}"; do
          echo "Verificando pattern: $pattern"
          matches=$(grep -r -n -E "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=dist || true)
          if [[ -n "$matches" ]]; then
            echo "âŒ CREDENCIAL DETECTADA:"
            echo "$matches"
            found=1
          fi
        done
        
        if [[ $found -eq 1 ]]; then
          echo "ï¿½ ALERTA: PossÃ­veis credenciais detectadas!"
          echo "âš ï¸ VerificaÃ§Ã£o manual recomendada"
          # NÃ£o falha o build, apenas alerta
        else
          echo "âœ… Nenhuma credencial detectada"
        fi

    - name: ğŸ“Š Security Report
      if: failure()
      run: |
        echo "ğŸš¨ ALERTA DE SEGURANÃ‡A!"
        echo "Credenciais foram detectadas no cÃ³digo."
        echo "âŒ Build falhado por motivos de seguranÃ§a."